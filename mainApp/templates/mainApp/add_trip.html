{% extends "mainApp/base.html" %}
{% load widget_tweaks %}
{% load static %}
{% block content %}
<div class="main-wrapper">
  <h1>Создать рейс</h1>
  <form method="post">
    {% csrf_token %}
    {{ trip_form.as_p }}
    {{ formset.management_form }}

    <div class="form-section-add-trip" id="form-container">
      {% for form in formset %}
        <div class="form-fields-add-trip">
          <input type="hidden" name="form-{{ forloop.counter0 }}-order" value="{{ forloop.counter }}">

          <div class="form-row-add-trip">
            {{ form.from_city.label_tag }}
            {{ form.from_city }}
          </div>
          <div class="form-row-add-trip">
            <label>Зупинка відправлення:</label>
            <select name="{{ form.from_place.html_name }}" class="from-place-select" data-pair="from-city-{{ forloop.counter0 }}">
              <option value="">-- оберіть зупинку --</option>
            </select>
          </div>

          <div class="form-row-add-trip">
            {{ form.to_city.label_tag }}
            {{ form.to_city }}
          </div>
          <div class="form-row-add-trip">
            <label>Зупинка прибуття:</label>
            <select name="{{ form.to_place.html_name }}" class="to-place-select" data-pair="to-city-{{ forloop.counter0 }}">
              <option value="">-- оберіть зупинку --</option>
            </select>
          </div>

          <div class="form-row-add-trip">
            {{ form.departure_datetime.label_tag }}
            {{ form.departure_datetime }}
          </div>
          <div class="form-row-add-trip">
            {{ form.arrival_datetime.label_tag }}
            {{ form.arrival_datetime }}
          </div>
          <div class="form-row-add-trip">
            {{ form.price_travel.label_tag }}
            {{ form.price_travel }}
          </div>
        </div>
      {% endfor %}
    </div>

    <div class="form-submit-add-trip">
      <div class="form-button-row-add-trip">
        <button type="button" id="add-form" class="btn-add-trip">＋ добавить маршрут</button>
        <button type="submit" class="btn-add-trip">Зберегти рейс</button>
      </div>
    </div>
  </form>

  <template id="form-template">
    <div class="form-fields-add-trip">
      <input type="hidden" name="form-__prefix__-order" value="__ORDER__">
      <div class="form-row-add-trip">
        <label>Місто відправлення:</label>
        <select name="form-__prefix__-from_city" class="from-city from-city-__prefix__" id="id_form-__prefix__-from_city">
          __CITY_OPTIONS__
        </select>
      </div>
      <div class="form-row-add-trip">
        <label>Зупинка відправлення:</label>
        <select name="form-__prefix__-from_place" class="from-place-select" data-pair="from-city-__prefix__">
          <option value="">-- оберіть зупинку --</option>
        </select>
      </div>

      <div class="form-row-add-trip">
        <label>Місто прибуття:</label>
        <select name="form-__prefix__-to_city" class="to-city to-city-__prefix__" id="id_form-__prefix__-to_city">
          __CITY_OPTIONS__
        </select>
      </div>
      <div class="form-row-add-trip">
        <label>Зупинка прибуття:</label>
        <select name="form-__prefix__-to_place" class="to-place-select" data-pair="to-city-__prefix__">
          <option value="">-- оберіть зупинку --</option>
        </select>
      </div>

      <div class="form-row-add-trip">
        <label for="id_form-__prefix__-departure_datetime">Время отправления:</label>
        <input type="datetime-local" name="form-__prefix__-departure_datetime" id="id_form-__prefix__-departure_datetime">
      </div>
      <div class="form-row-add-trip">
        <label for="id_form-__prefix__-arrival_datetime">Время прибытия:</label>
        <input type="datetime-local" name="form-__prefix__-arrival_datetime" id="id_form-__prefix__-arrival_datetime">
      </div>
      <div class="form-row-add-trip">
        <label for="id_form-__prefix__-price_travel">Цена:</label>
        <input type="number" name="form-__prefix__-price_travel" id="id_form-__prefix__-price_travel" step="0.01">
      </div>
    </div>
  </template>
</div>


 <script>
  document.addEventListener('DOMContentLoaded', function () {
    const totalForms = document.getElementById('id_form-TOTAL_FORMS');
    const addFormBtn = document.getElementById('add-form');
    const formContainer = document.getElementById('form-container');
    const formTemplate = document.getElementById('form-template').innerHTML;

    const cityOptions = `{{ get_city_options|safe }}`;
    let formIndex = parseInt(totalForms.value);

    addFormBtn.addEventListener('click', function () {
      const html = formTemplate
        .replace(/__prefix__/g, formIndex)
        .replace(/__ORDER__/g, formIndex + 1)
        .replace(/__CITY_OPTIONS__/g, cityOptions);

      const formBlock = document.createElement('div');
      formBlock.innerHTML = html;
      formContainer.appendChild(formBlock);

      totalForms.value = formIndex + 1;
      attachCityListeners(formIndex);
      formIndex++;
    });




    function loadStations(cityId, placeSelect) {
      if (!cityId) return;
      fetch(`/api/get-stations/?city_id=${cityId}`)
          .then(response => response.json())
          .then(data => {
            placeSelect.innerHTML = '<option value="">-- оберіть зупинку --</option>';
            data.stations.forEach(station => {
              const option = document.createElement('option');
              option.value = station.id;     // value — id станции
              option.textContent = station.name;  // текст — имя станции
              placeSelect.appendChild(option);
            });
          });
    }

    function attachCityListeners(index) {
      const fromCity = document.querySelector(`.from-city-${index}`);
      const toCity = document.querySelector(`.to-city-${index}`);

      if (fromCity) {
        fromCity.addEventListener('change', function () {
          const pair = `from-city-${index}`;
          const placeSelect = document.querySelector(`.from-place-select[data-pair="${pair}"]`);
          loadStations(this.value, placeSelect);
        });
      }

      if (toCity) {
        toCity.addEventListener('change', function () {
          const pair = `to-city-${index}`;
          const placeSelect = document.querySelector(`.to-place-select[data-pair="${pair}"]`);
          loadStations(this.value, placeSelect);
        });
      }
    }






    for (let i = 0; i < formIndex; i++) {
      attachCityListeners(i);
    }
  });
</script>

{% endblock content %}

